# ? ???? ????????? ??????? - GMB Dashboard Fixes

## ? ???? ????????? ?? ??????? ?????!

---

## 1. ? ????? ??? CRITICAL ?? Sync Route

**?????:** `app/api/gmb/sync/route.ts`

**?????????:**
- ? ????? `const userId = user?.id || account.user_id;` ??? ????? 799
- ? ??????? ???? `user_id: user.id` ?? `user_id: userId` ??:
  - ????? 917: locationRows ?
  - ????? 1001: reviewRows ?
  - ????? 1045: mediaRows ?
  - ????? 1123: metricRows ?
  - ????? 1171: keywordRows ?

**???????:** ????? ????? ?? ?????? - ?? ???? null reference error ?? cron requests

---

## 2. ? ????? Error Handling ?? Token Refresh

**?????:** `app/api/gmb/posts/publish/route.ts`

**?????????:**
- ? ????? try-catch ???? ??? token refresh (?????? 71-97)
- ? ????? error handling ?? error codes:
  - `TOKEN_REFRESH_FAILED` (????? 87)
  - `TOKEN_REFRESH_ERROR` (????? 94)
- ? ????? ??? ????? ????????

**???????:** ?????? ????? ???? ??? ??? token refresh

---

## 3. ? ????? Potential Crash ?? Performance Chart

**?????:** `components/dashboard/performance-chart.tsx`

**?????????:**
- ? ????? ??? ??? valid ratings ??? ??????? Math.min/Max (?????? 88-91)
- ? ????? fallback domain [0, 5] ??? ?? ???? valid ratings
- ? ??????? `let domain` ????? ?? `const` ???? if block

**???????:** ?? ???? crash ??? ???? NaN ?? undefined ?? ratings

---

## ? ?????? ?? ?????????

### ????? ?????? ??????:

#### 1. Sync Route:
```bash
grep -n "const userId = user?.id" app/api/gmb/sync/route.ts
# ??? ?? ????: 800:    const userId = user?.id || account.user_id;
```

```bash
grep -n "user_id: userId" app/api/gmb/sync/route.ts
# ??? ?? ???? 5 ????? ?? ??????: 917, 1001, 1045, 1123, 1171
```

#### 2. Publish Route:
```bash
grep -n "TOKEN_REFRESH" app/api/gmb/posts/publish/route.ts
# ??? ?? ????: 87 ? 94
```

#### 3. Performance Chart:
```bash
grep -n "validRatings" components/dashboard/performance-chart.tsx
# ??? ?? ???? ??????: 88-91
```

---

## ? ?????? ????????

- ? **?? ???? ????? linting**
- ? **???? ????????? ?????? ?? ???????**
- ? **????? ???? ???????**

---

## ?? ???????

??? ??? ???? ????? ?? ???????:
1. ???? ?? ??? ??????? (Ctrl+S)
2. ??? ????? dev server ??? ??? ????
3. ???? ?? ?? ??????? ?? ????? ?????? ??? ??????? ?? Editor

---

*?????: $(date +"%Y-%m-%d %H:%M:%S")*
*???? ????????? ?? ??????? ????? ?*
