{
  "summary": "Found 4 critical, 8 high, 6 medium, 4 low issues across 22 files",
  "critical": [
    {
      "issue": "SQL Injection Vulnerability in Search Query",
      "description": "The search parameter is directly interpolated into the SQL query without proper sanitization, allowing potential SQL injection attacks",
      "impact": "Attackers could execute malicious SQL queries, potentially accessing or modifying unauthorized data",
      "location": "app/api/locations/list-data/route.ts:49-54",
      "currentCode": "if (search) {\n    const sanitizedSearch = search.trim().slice(0, 100);\n    if (sanitizedSearch) {\n      const escapedSearch = sanitizedSearch.replace(/%/g, '\\\\%').replace(/_/g, '\\\\_');\n      query = query.or(`location_name.ilike.%${escapedSearch}%,address.ilike.%${escapedSearch}%`)\n    }\n  }",
      "category": "security"
    },
    {
      "issue": "Missing Authentication in Bulk Publish API",
      "description": "The bulk publish endpoint lacks proper session validation and could allow unauthorized access to publish posts to locations",
      "impact": "Unauthorized users could potentially publish content to GMB locations they don't own",
      "location": "app/api/locations/bulk-publish/route.ts:15-25",
      "currentCode": "const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n  if (authError || !user) {\n    console.error('Authentication error:', authError);\n    return NextResponse.json(\n      { \n        error: 'Unauthorized',\n        message: 'Authentication required. Please sign in again.'\n      }, \n      { status: 401 }\n    );\n  }",
      "category": "security"
    },
    {
      "issue": "Google Maps API Key Exposed in Client-Side Code",
      "description": "The Google Maps API key is accessed via process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY, making it visible to clients",
      "impact": "API key exposure could lead to unauthorized usage and potential billing abuse",
      "location": "components/locations/LocationMapDashboard.tsx:50",
      "currentCode": "googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || 'YOUR_GOOGLE_MAPS_API_KEY',",
      "category": "security"
    },
    {
      "issue": "Unsafe Direct Object Reference in Location Access",
      "description": "Location access is not properly validated against user ownership in multiple components",
      "impact": "Users might be able to access locations belonging to other users",
      "location": "app/api/locations/[locationId]/cover/route.ts:25-30",
      "currentCode": "const { data: location, error: locationError } = await supabase\n      .from('gmb_locations')\n      .select('name, gmb_account_id, store_code')\n      .eq('id', locationId)\n      .eq('user_id', user.id)\n      .single();",
      "category": "security"
    }
  ],
  "high": [
    {
      "issue": "Missing Error Handling in Location Card Media Fetch",
      "description": "The fetchLocationMedia function lacks proper error handling for failed API requests",
      "impact": "Unhandled errors could crash the component or leave it in an inconsistent state",
      "location": "components/locations/location-card.tsx:44-73",
      "currentCode": "async function fetchLocationMedia() {\n      try {\n        setLoadingMedia(true)\n        const response = await fetch(`/api/gmb/media?locationId=${location.id}`)\n        const result = await response.json()\n        \n        if (response.ok && result.data?.media) {",
      "category": "error-handling"
    },
    {
      "issue": "Race Condition in Location State Updates",
      "description": "Multiple async operations update location state without checking if component is still mounted",
      "impact": "Memory leaks and state updates on unmounted components causing React warnings",
      "location": "components/locations/LocationMapDashboard.tsx:75-95",
      "currentCode": "const fetchMapData = useCallback(async () => {\n    if (!isMountedRef.current) return;\n    \n    setLoadingData(true);\n    setErrorData(null);\n    try {\n      const response = await fetch('/api/locations/map-data');",
      "category": "bugs"
    },
    {
      "issue": "Null Reference Error in Location Metadata Access",
      "description": "Location metadata is accessed without null checks in multiple places",
      "impact": "Runtime errors when metadata is null or undefined",
      "location": "components/locations/location-card.tsx:36-40",
      "currentCode": "const metadata = (location.metadata as any) || {}\n  const profile = metadata.profile || {}\n  const regularHours = metadata.regularHours || {}\n  const openInfo = metadata.openInfo || {}\n  const serviceItems = metadata.serviceItems || []",
      "category": "bugs"
    },
    {
      "issue": "Missing Try-Catch in Critical API Operations",
      "description": "OAuth token refresh operations lack proper error handling",
      "impact": "Token refresh failures could break authentication flow without user feedback",
      "location": "app/api/locations/[locationId]/cover/route.ts:60-75",
      "currentCode": "if (now >= expiresAt && tokenData.refresh_token) {\n      // Token expired, refresh it\n      const refreshResponse = await fetch('https://oauth2.googleapis.com/token', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n        body: new URLSearchParams({\n          client_id: process.env.GOOGLE_CLIENT_ID!,\n          client_secret: process.env.GOOGLE_CLIENT_SECRET!,\n          refresh_token: tokenData.refresh_token,\n          grant_type: 'refresh_token',\n        }),\n      });",
      "category": "error-handling"
    },
    {
      "issue": "Unhandled Promise Rejection in Bulk Operations",
      "description": "Bulk publish operations don't handle individual location failures properly",
      "impact": "Failed operations on one location could affect the entire batch",
      "location": "app/api/locations/bulk-publish/route.ts:120-150",
      "currentCode": "for (const locationId of locationIds) {\n      try {\n        // بناء مسار المورد المطلوب لـ GMB API\n        const locationResource = buildLocationResourceName(account.account_id, locationId);",
      "category": "error-handling"
    },
    {
      "issue": "Memory Leak in Map Component Cleanup",
      "description": "Google Maps markers and info windows are not properly cleaned up on component unmount",
      "impact": "Memory leaks and potential browser performance degradation",
      "location": "components/locations/LocationMapDashboard.tsx:65-85",
      "currentCode": "useEffect(() => {\n    isMountedRef.current = true;\n    \n    return () => {\n      isMountedRef.current = false;\n      \n      // ✅ Cleanup Google Maps markers\n      markersRef.current.forEach(marker => {\n        if (marker) {\n          marker.setMap(null);\n        }\n      });",
      "category": "bugs"
    },
    {
      "issue": "Infinite Re-render Risk in useEffect Dependencies",
      "description": "useEffect hooks have missing or incorrect dependency arrays that could cause infinite loops",
      "impact": "Performance degradation and potential browser freezing",
      "location": "components/locations/enhanced-location-card.tsx:25-35",
      "currentCode": "useEffect(() => {\n    const fetchImages = async () => {\n      try {\n        setLoadingImages(true);",
      "category": "performance"
    },
    {
      "issue": "No Input Validation for Location IDs",
      "description": "Location IDs are not validated for proper UUID format in some API endpoints",
      "impact": "Invalid input could cause database errors or unexpected behavior",
      "location": "app/api/locations/competitor-data/route.ts:45-50",
      "currentCode": "const url = new URL(request.url);\n        const radius = parseInt(url.searchParams.get('radius') || '5000', 10);\n        \n        if (radius < 100 || radius > 50000) {\n            return NextResponse.json(\n                { error: 'Invalid radius', message: 'Radius must be between 100 and 50000 meters' },",
      "category": "validation"
    }
  ],
  "medium": [
    {
      "issue": "Missing React.memo for Performance Optimization",
      "description": "Location cards and other components re-render unnecessarily without memoization",
      "impact": "Reduced performance with large location lists",
      "location": "components/locations/enhanced-location-card.tsx:15",
      "currentCode": "export const EnhancedLocationCard: React.FC<EnhancedLocationCardProps> = ({ \n  location,\n  onEdit \n}) => {",
      "category": "performance"
    },
    {
      "issue": "Loading State Not Cleared on Error",
      "description": "Loading states are not properly cleared when errors occur in several components",
      "impact": "UI remains in loading state indefinitely on errors",
      "location": "components/locations/location-card.tsx:44-60",
      "currentCode": "async function fetchLocationMedia() {\n      try {\n        setLoadingMedia(true)\n        const response = await fetch(`/api/gmb/media?locationId=${location.id}`)\n        const result = await response.json()\n        \n        if (response.ok && result.data?.media) {",
      "category": "ui-state"
    },
    {
      "issue": "Missing Accessibility Labels",
      "description": "Interactive elements lack proper aria-labels and accessibility attributes",
      "impact": "Poor accessibility for screen readers and keyboard navigation",
      "location": "components/locations/lazy-locations-components.tsx:45-50",
      "currentCode": "<Button size=\"sm\" variant=\"ghost\" onClick={() => onEditAction(location.id)}>\n              <Edit3 className=\"w-4 h-4\" />\n            </Button>\n            <Button size=\"sm\" variant=\"ghost\" onClick={() => onViewDetailsAction(location.id)}>\n              <Eye className=\"w-4 h-4\" />\n            </Button>",
      "category": "accessibility"
    },
    {
      "issue": "No Debouncing for Search Input",
      "description": "Search input triggers API calls on every keystroke without debouncing",
      "impact": "Excessive API calls and poor performance",
      "location": "components/locations/locations-filters.tsx:25-30",
      "currentCode": "<Input\n                placeholder={t('filters.searchPlaceholder')}\n                value={searchTerm}\n                onChange={(e) => onSearchChange(e.target.value)}\n                className=\"pl-10\"\n              />",
      "category": "performance"
    },
    {
      "issue": "Hardcoded API Endpoints",
      "description": "API endpoints are hardcoded throughout components instead of using constants",
      "impact": "Difficult to maintain and update API endpoints",
      "location": "components/locations/location-card.tsx:49",
      "currentCode": "const response = await fetch(`/api/gmb/media?locationId=${location.id}`)",
      "category": "maintainability"
    },
    {
      "issue": "Missing Error Boundaries for Location Components",
      "description": "Individual location cards don't have error boundaries to prevent cascade failures",
      "impact": "One failed location card could break the entire locations list",
      "location": "components/locations/locations-list.tsx:350-370",
      "currentCode": "{filteredLocations.map((location, index) => (\n                <LocationCard key={location.id} location={location} index={index} />\n              ))}",
      "category": "error-handling"
    }
  ],
  "low": [
    {
      "issue": "Using 'any' Type Extensively",
      "description": "Many components use 'any' type instead of proper TypeScript interfaces",
      "impact": "Loss of type safety and potential runtime errors",
      "location": "components/locations/location-card.tsx:36",
      "currentCode": "const metadata = (location.metadata as any) || {}",
      "category": "types"
    },
    {
      "issue": "Console.log Statements in Production Code",
      "description": "Debug console.log statements are present in production code",
      "impact": "Information leakage and console pollution",
      "location": "components/locations/location-profile-enhanced.tsx:85-90",
      "currentCode": "console.log('[LocationProfile] Media item:', {\n              category,\n              url: url.substring(0, 50) + '...',\n              hasLocationAssociation: !!item.locationAssociation,\n              hasMetadata: !!item.metadata,\n              allKeys: Object.keys(item)\n            })",
      "category": "code-quality"
    },
    {
      "issue": "Inconsistent Error Message Formatting",
      "description": "Error messages have inconsistent structure and formatting across components",
      "impact": "Poor user experience with inconsistent error presentation",
      "location": "components/locations/locations-error-alert.tsx:15-25",
      "currentCode": "<h3 className=\"font-semibold text-destructive\">{t('errors.loadFailed')}</h3>\n            <p className=\"text-sm text-muted-foreground mt-1\">{error}</p>",
      "category": "user-experience"
    },
    {
      "issue": "Missing PropTypes or Default Props",
      "description": "Components lack default props for optional parameters",
      "impact": "Potential undefined errors when optional props are not provided",
      "location": "components/locations/responsive-locations-layout.tsx:45-50",
      "currentCode": "export function MobileLocationCard({ \n  location, \n  onSelectAction, \n  isSelected = false \n}: {\n  location: any;\n  onSelectAction?: (location: any) => void;\n  isSelected?: boolean;\n}) {",
      "category": "code-quality"
    }
  ],
  "recommendations": [
    {
      "priority": "Critical",
      "action": "Implement proper input sanitization and parameterized queries",
      "description": "Replace string interpolation in SQL queries with proper parameterized queries to prevent SQL injection attacks"
    },
    {
      "priority": "Critical",
      "action": "Add comprehensive authentication validation",
      "description": "Implement proper session validation and user authorization checks in all API endpoints"
    },
    {
      "priority": "High",
      "action": "Add comprehensive error boundaries",
      "description": "Implement error boundaries around location components to prevent cascade failures and improve user experience"
    },
    {
      "priority": "High",
      "action": "Implement proper async error handling",
      "description": "Add try-catch blocks around all async operations with proper error state management"
    },
    {
      "priority": "Medium",
      "action": "Optimize component performance",
      "description": "Add React.memo, useCallback, and useMemo to prevent unnecessary re-renders"
    },
    {
      "priority": "Medium",
      "action": "Improve accessibility compliance",
      "description": "Add proper aria-labels, keyboard navigation, and screen reader support"
    },
    {
      "priority": "Low",
      "action": "Strengthen TypeScript usage",
      "description": "Replace 'any' types with proper interfaces and add strict type checking"
    }
  ],
  "filesAffected": [
    "app/api/locations/list-data/route.ts",
    "app/api/locations/bulk-publish/route.ts",
    "app/api/locations/[locationId]/cover/route.ts",
    "app/api/locations/[locationId]/logo/route.ts",
    "app/api/locations/competitor-data/route.ts",
    "app/api/locations/map-data/route.ts",
    "components/locations/LocationMapDashboard.tsx",
    "components/locations/location-card.tsx",
    "components/locations/enhanced-location-card.tsx",
    "components/locations/location-profile-enhanced.tsx",
    "components/locations/locations-list.tsx",
    "components/locations/locations-filters.tsx",
    "components/locations/lazy-locations-components.tsx",
    "components/locations/responsive-locations-layout.tsx",
    "components/locations/locations-error-alert.tsx",
    "app/[locale]/(dashboard)/locations/page.tsx",
    "app/[locale]/(dashboard)/locations/optimized-page.tsx",
    "components/locations/add-location-dialog.tsx",
    "components/locations/edit-location-dialog.tsx",
    "components/locations/location-attributes-dialog.tsx",
    "components/locations/gmb-connection-banner.tsx",
    "components/locations/location-types.tsx"
  ]
}