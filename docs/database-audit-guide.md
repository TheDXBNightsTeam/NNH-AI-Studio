# ???? ??? ????? ???????? - GMB Dashboard

## ?? ??? ????? ??????

### ?????? 1: ????? Audit Script

```bash
# ??? ??? ?????? Supabase CLI
supabase db execute --file sql/database_audit.sql

# ?? ??? ??? ?????? psql ??????
psql -h your-db-host -U your-user -d your-database -f sql/database_audit.sql
```

### ?????? 2: ?????? ???????

??? script ?????:
1. ? Table existence check
2. ?? Duplicate locations
3. ?? Orphaned records
4. ?? Missing constraints
5. ?? Statistics

---

## ?? ??? ???? (Quick Check)

### 1. ??? Duplicate Locations

```sql
-- Check for duplicates
SELECT 
  normalized_location_id,
  COUNT(*) as count
FROM gmb_locations
WHERE normalized_location_id IS NOT NULL
GROUP BY normalized_location_id, gmb_account_id
HAVING COUNT(*) > 1;
```

**??????? ????????**: 0 rows (?? duplicates)

---

### 2. ??? Orphaned Records

```sql
-- Orphaned reviews
SELECT COUNT(*) 
FROM gmb_reviews r
LEFT JOIN gmb_locations l ON r.location_id = l.id
WHERE r.location_id IS NOT NULL AND l.id IS NULL;

-- Orphaned posts
SELECT COUNT(*) 
FROM gmb_posts p
LEFT JOIN gmb_locations l ON p.location_id = l.id
WHERE p.location_id IS NOT NULL AND l.id IS NULL;
```

**??????? ????????**: 0 (?? orphaned records)

---

### 3. ??? Constraints

```sql
-- Check unique constraint exists
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'gmb_locations'
  AND constraint_name = 'unique_location_per_account_normalized';
```

**??????? ????????**: 1 row (constraint ?????)

---

### 4. ??? Indexes

```sql
-- Check indexes on gmb_locations
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'gmb_locations'
  AND indexname LIKE '%normalized%';
```

**??????? ????????**: 
- `idx_gmb_locations_normalized_id`
- `idx_gmb_locations_account_normalized`

---

## ?? ????? ?????????

### ????? ??

**??? ????? Migration**:
1. ? Backup ????? ????????
2. ? ????? ?? Staging ?????
3. ? ???? ???????? ???? ???? ?????

### ????? Fix Migration

```bash
# ??????? Supabase CLI
supabase migration up 20250131_fix_database_issues

# ?? ??????
psql -h your-db-host -U your-user -d your-database \
  -f supabase/migrations/20250131_fix_database_issues.sql
```

---

## ?? Monitoring ??? ???????

### 1. Daily Check Script

```sql
-- Run this daily to monitor for new duplicates
SELECT 
  'DUPLICATE_CHECK' as check_type,
  COUNT(*) as duplicate_count
FROM (
  SELECT normalized_location_id, gmb_account_id
  FROM gmb_locations
  WHERE normalized_location_id IS NOT NULL
  GROUP BY normalized_location_id, gmb_account_id
  HAVING COUNT(*) > 1
) duplicates;
```

### 2. Data Integrity Check

```sql
-- Run this weekly
SELECT 
  'INTEGRITY_CHECK' as check_type,
  (SELECT COUNT(*) FROM gmb_reviews WHERE location_id NOT IN (SELECT id FROM gmb_locations)) as orphaned_reviews,
  (SELECT COUNT(*) FROM gmb_posts WHERE location_id NOT IN (SELECT id FROM gmb_locations)) as orphaned_posts,
  (SELECT COUNT(*) FROM gmb_locations WHERE gmb_account_id IS NULL) as locations_without_account;
```

---

## ?? Troubleshooting

### ???????: Migration ???

**????**:
1. ???? ?? logs
2. ???? ?? permissions
3. ???? ?? ??? ???? locks

### ???????: Duplicates ?? ???? ??????

**????**:
1. ???? ?? trigger ????
2. ???? ?? constraint ?????
3. ???? data manually

### ???????: Performance ???? ??? Migration

**????**:
1. ???? ?? indexes ?? ???????
2. ???? query plans
3. Update statistics: `ANALYZE gmb_locations;`

---

## ?? Checklist ????

### ??? Migration:
- [ ] Backup ????? ????????
- [ ] ????? ?? Staging
- [ ] ???? SQL script
- [ ] ???? ?? permissions

### ??? Migration:
- [ ] ???? ?? ?? duplicates
- [ ] ???? ?? constraints
- [ ] ???? ?? indexes
- [ ] ???? ?? triggers
- [ ] ????? sync operations
- [ ] ???? performance

---

## ?? ????? ?????

- **Audit Script**: `/sql/database_audit.sql`
- **Fix Migration**: `/supabase/migrations/20250131_fix_database_issues.sql`
- **Full Report**: `/docs/database-audit-report.md`

---

*??? ?????: 2025-01-31*
