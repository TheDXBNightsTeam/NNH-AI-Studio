# ????? ??? ????? ???????? - GMB Dashboard
## ????? ?????: 2025-01-31

---

## ?? ???? ??????

?? ????? ??? ???? ?????? ???????? ????? ??:
- ????????? (Duplicates)
- ????? ????? ???????? (Data Integrity)
- Constraints ????????
- Indexes ????????
- ????? ??????

---

## ?? ??????? ?????????

1. **Audit Script**: `sql/database_audit.sql`
   - ??? ???? ??? ???????
   - ????? ?????????
   - ??? Constraints ? Indexes
   - ??? RLS Policies

2. **Fix Migration**: `supabase/migrations/20250131_fix_database_issues.sql`
   - ????? ?????????
   - ????? Constraints
   - ????? Indexes

---

## ?? ??????? ?????? ????????

### 1. ????? Duplicate Locations (Critical) ??

**?????**: 
- Locations ???? ????? ???? formats ?????? ?? `location_id`
- ??? locations ???? ?? `locations/123456`
- ???? ???? ?? `accounts/.../locations/123456`
- ?????? ?? ????? ????? ??? ??????

**??????**:
- ?????? ????? ?? Dashboard
- ???????? ??? ?????
- ????? ?? performance
- ????? ?? ????? Locations

**???? ??????**:
```sql
-- 1. ????? normalized_location_id column
ALTER TABLE gmb_locations
ADD COLUMN normalized_location_id TEXT;

-- 2. Extract location ID ?? formats ??????
UPDATE gmb_locations
SET normalized_location_id = 
  CASE 
    WHEN location_id LIKE 'locations/%' THEN 
      SUBSTRING(location_id FROM 'locations/([^/]+)$')
    WHEN location_id LIKE 'accounts/%/locations/%' THEN 
      SUBSTRING(location_id FROM 'locations/([^/]+)$')
    ELSE location_id
  END;

-- 3. ??? ????????? (???????? ???????)
-- 4. ????? unique constraint
ALTER TABLE gmb_locations
ADD CONSTRAINT unique_location_per_account_normalized 
UNIQUE (gmb_account_id, normalized_location_id);
```

---

### 2. Orphaned Records (High Priority) ??

**?????**: 
- Reviews ???? locations (location_id ???? ?? location ?????)
- Posts ???? locations
- Media ???? locations
- Performance metrics ???? locations

**??????**:
- ?????? ????? (orphaned data)
- ????? ?? queries
- ????? ???????? ????????

**???? ??????**:
```sql
-- Update orphaned records to point to kept location
-- ?? Delete ??? ??? ?? ???? ???????
UPDATE gmb_reviews
SET location_id = (SELECT id FROM gmb_locations WHERE ...)
WHERE location_id NOT EXISTS (...);
```

---

### 3. Missing Constraints (Medium Priority) ??

**?????**:
- ?? ???? unique constraint ??? `(gmb_account_id, normalized_location_id)`
- ?? ???? ???? duplicate `external_review_id`
- ?? ???? ???? duplicate `external_media_id`

**???? ??????**:
```sql
-- Unique constraint for external_review_id
ALTER TABLE gmb_reviews
ADD CONSTRAINT gmb_reviews_external_review_id_key 
UNIQUE (external_review_id);

-- Unique constraint for external_media_id
ALTER TABLE gmb_media
ADD CONSTRAINT gmb_media_external_media_id_key 
UNIQUE (external_media_id);
```

---

### 4. Missing Indexes (Performance) ??

**?????**:
- ??? queries ?? ???? ????? ???? missing indexes
- ???? ??? columns ????????? ?? WHERE clauses

**???? ??????**:
```sql
-- Indexes for common queries
CREATE INDEX idx_gmb_locations_account_active 
ON gmb_locations(gmb_account_id, is_active) 
WHERE is_active = true;

CREATE INDEX idx_gmb_reviews_location_status 
ON gmb_reviews(location_id, status) 
WHERE status IN ('new', 'in_progress');

CREATE INDEX idx_gmb_posts_scheduled 
ON gmb_posts(scheduled_at) 
WHERE scheduled_at IS NOT NULL AND status = 'queued';
```

---

## ?? ????? ???????

### gmb_accounts

**??????**: ? ??? ??????

**???????**:
- ?? ???? ???? accounts ???? user_id (????????)

**???????**:
```sql
-- Fix accounts without user_id
UPDATE gmb_accounts
SET user_id = (SELECT id FROM auth.users WHERE ...)
WHERE user_id IS NULL;
```

---

### gmb_locations

**??????**: ?? ????? ????

**???????**:
1. ? **?? ???????**: Duplicate locations ???? location_id formats
2. ?? **??? ????????**: Locations ???? account_id
3. ?? **??? ????????**: Locations ???? user_id

**????????? ???????**:
- ? ????? normalized_location_id
- ? ??? ?????????
- ? ????? unique constraint
- ? ????? trigger ?? auto-update

---

### gmb_reviews

**??????**: ?? ????? ?????

**???????**:
1. ?? Orphaned reviews (location ?????)
2. ?? Reviews ???? user_id
3. ?? ?? ???? ???? duplicate external_review_id

**????????? ???????**:
- ? Update orphaned reviews
- ? Unique constraint ??? external_review_id
- ? Indexes ??????

---

### gmb_posts

**??????**: ?? ????? ?????

**???????**:
1. ?? Orphaned posts
2. ?? Missing indexes ??? scheduled posts

**????????? ???????**:
- ? Update orphaned posts
- ? Indexes ??? scheduled posts

---

## ?? RLS Policies Check

**??????**: ? ???

**??????**:
- ? RLS ???? ??? ???? ???????
- ? Policies ????? ???? ????
- ? Users ?????? ??? ?????? ?????????

**?????????**:
- Policies ?????? `auth.uid() = user_id` ???? ????
- ?? ???? ????? ????? ????? ?? RLS

---

## ?? Performance Analysis

### Table Sizes

??? ??? ????? ???????:
```sql
SELECT 
  tablename,
  pg_size_pretty(pg_total_relation_size('public.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename LIKE 'gmb_%'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
```

### Index Usage

??? indexes ???????:
- ? `idx_gmb_locations_normalized_id`
- ? `idx_gmb_locations_account_normalized`
- ? `idx_gmb_locations_account_active`
- ? `idx_gmb_reviews_location_status`
- ? `idx_gmb_posts_location_status`
- ? `idx_gmb_posts_scheduled`

---

## ?? Trigger Implementation

### Auto-Update normalized_location_id

**?????**: Trigger ???? ?? auto-update `normalized_location_id` ??? insert/update

**?????**:
```sql
CREATE TRIGGER trigger_update_normalized_location_id
BEFORE INSERT OR UPDATE OF location_id ON gmb_locations
FOR EACH ROW
EXECUTE FUNCTION public.update_normalized_location_id();
```

**???????**:
- ???? ?? `normalized_location_id` ?????? ????
- ???? ????????? ??????????

---

## ? Checklist ?????????

### ?? ???????:
- [x] Duplicate locations detection
- [x] normalized_location_id column
- [x] Delete duplicate locations
- [x] Update orphaned reviews
- [x] Update orphaned posts
- [x] Update orphaned media
- [x] Unique constraint ??? normalized_location_id
- [x] Unique constraint ??? external_review_id
- [x] Indexes ??????
- [x] Trigger ?? auto-update

### ????? ??????:
- [ ] Accounts ???? user_id
- [ ] Locations ???? account_id
- [ ] Reviews ???? user_id
- [ ] Data validation rules

---

## ?? ??????? ???????

### Immediate (?????):
1. **????? Migration**:
   ```bash
   # Run the fix migration
   supabase migration up 20250131_fix_database_issues
   ```

2. **????? Audit Script**:
   ```bash
   # Run audit to verify fixes
   psql -f sql/database_audit.sql
   ```

3. **?????? ?? ???????**:
   - ?????? ?? ??? ???? duplicates
   - ?????? ?? constraints
   - ?????? ?? indexes

### Short-term (??? ???????):
1. **Monitor Performance**:
   - ??? query performance
   - ????? indexes ??? ??? ?????

2. **Data Cleanup**:
   - ?????? orphaned records ????????
   - ?????? records ???? user_id

3. **Testing**:
   - ?????? sync operations
   - ?????? duplicate prevention

### Long-term (??? ?????):
1. **Monitoring**:
   - ????? monitoring ??? duplicates
   - ????? alerts ??? data integrity issues

2. **Documentation**:
   - ????? schema
   - ????? constraints
   - ????? triggers

---

## ?? ??????? ????

### ??? ????? Migration:

1. **Backup Database**:
   ```bash
   # Create backup before migration
   pg_dump -h your-host -U your-user -d your-db > backup.sql
   ```

2. **Review Deletions**:
   - Migration ????? duplicate locations
   - ???? ?? ?????? ???????? ??? ?????

3. **Test in Staging**:
   - ????? Migration ?? staging ?????
   - ???? ?? ??????? ??? Production

### ??? ????? Migration:

1. **Verify Fixes**:
   ```sql
   -- Check for remaining duplicates
   SELECT normalized_location_id, COUNT(*)
   FROM gmb_locations
   GROUP BY normalized_location_id, gmb_account_id
   HAVING COUNT(*) > 1;
   ```

2. **Monitor Performance**:
   - ???? query performance
   - ???? ?? ??????? indexes

3. **Update Application Code**:
   - ????? code ??????? `normalized_location_id` ??? ??? ?????
   - ????? deduplication logic ?? frontend

---

## ?? Statistics

### Expected Results ??? Migration:

- **Duplicate Locations**: 0 (?? X)
- **Orphaned Reviews**: 0 (?? X)
- **Orphaned Posts**: 0 (?? X)
- **Missing Constraints**: 0 (?? 3)
- **Missing Indexes**: 0 (?? 5+)

---

## ?? ??????? ????????

1. **Audit Script**: `/sql/database_audit.sql`
2. **Fix Migration**: `/supabase/migrations/20250131_fix_database_issues.sql`
3. **Original Schema**: `/scripts/001_create_gmb_schema.sql`

---

## ? ???????

????? ???????? ????? ??? ??? ????? ???? ????:
1. **Duplicate Locations** - ?? ??????? ?
2. **Orphaned Records** - ?? ??????? ?
3. **Missing Constraints** - ?? ??????? ?
4. **Performance Issues** - ?? ??????? ?

**???????**: ????? Migration ?? ???? ??? ???? ??? ?????? ????????.

---

*?? ????? ??? ??????? ?????? AI Assistant ?? 2025-01-31*
