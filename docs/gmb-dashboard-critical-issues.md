# ??????? ?????? - GMB Dashboard
## ????? ??? ?? ????

---

## ?? ??????? ?????? (Critical)

### 1. ????? Duplicate Locations ??

**?????**: Locations ?? ???? ????? ???? formats ?????? ?? `location_id`

**??????**: 
- `components/locations/locations-list.tsx` (lines 158-205)
- Multiple SQL scripts ?? `/sql` directory

**???????**:
```typescript
// location_id ?? ???? ?formats ??????:
// - "locations/11247391224469965786"
// - "accounts/.../locations/11247391224469965786"
```

**???? ???????**:
1. Normalize `location_id` ?? database level
2. ????? unique constraint ??? normalized location_id
3. ????? deduplication logic ?? frontend

**SQL Solution**:
```sql
-- Add computed column for normalized location_id
ALTER TABLE gmb_locations 
ADD COLUMN normalized_location_id TEXT GENERATED ALWAYS AS (
  SUBSTRING(location_id FROM 'locations/([^/]+)$')
) STORED;

-- Add unique constraint
ALTER TABLE gmb_locations 
ADD CONSTRAINT unique_location_per_account 
UNIQUE (gmb_account_id, normalized_location_id);
```

---

### 2. Missing Input Validation ??

**?????**: APIs ?? ????? ?? ??? ???????? ???????

**???????**:
- `app/api/gmb/posts/create/route.ts` (line 36)
- `app/api/gmb/sync/route.ts` (line 758)
- ???? API endpoints

**???????**:
```typescript
// ?? ???? validation ???:
// - Content length (posts)
// - URL format (media URLs)
// - Date format (scheduled posts)
// - Location IDs format
```

**???? ???????**:
??????? Zod schema validation:

```typescript
import { z } from 'zod'

const CreatePostSchema = z.object({
  locationId: z.string().uuid(),
  content: z.string().min(1).max(1500),
  title: z.string().max(100).optional(),
  mediaUrl: z.string().url().optional(),
  // ...
})
```

---

### 3. Inconsistent Error Handling ??

**?????**: Error responses ??? ????? ??? APIs

**???????**: ???? API endpoints

**???????**:
```typescript
// ??? APIs ????:
{ error: 'Message' }

// ???? ????:
{ error: 'Message', details: {...} }

// ???? ????:
{ ok: false, error: 'Message' }
```

**???? ???????**:
????? error response format:

```typescript
interface ApiError {
  error: {
    code: string
    message: string
    details?: unknown
  }
}
```

---

### 4. Token Refresh Logic ??

**?????**: Token refresh logic ?? ???? ?? ??? ???????

**??????**: 
- `app/api/gmb/sync/route.ts` (lines 82-140)
- `app/api/gmb/posts/publish/route.ts` (lines 6-22)

**???????**:
```typescript
// 5 minute buffer ?? ?? ???? ??????
if (expiresAt && expiresAt > new Date(now.getTime() + 5 * 60000)) {
  return account.access_token
}
```

**???? ???????**:
```typescript
// Increase buffer or check more frequently
const BUFFER_MINUTES = 10
if (expiresAt && expiresAt > new Date(now.getTime() + BUFFER_MINUTES * 60000)) {
  return account.access_token
}
```

---

### 5. Security: Error Messages ??

**?????**: ??? error messages ?? ???? ??????? ?????

**???????**: ???? API endpoints

**???????**:
```typescript
// ?? sync/route.ts - line 1218
return NextResponse.json({
  error: error.message || 'Sync failed'
})
```

**???? ???????**:
```typescript
// ?? production? ?? ???? error.message ??????
const errorCode = getErrorCode(error)
return NextResponse.json({
  error: {
    code: errorCode,
    message: getUserFriendlyMessage(errorCode)
  }
})
```

---

## ?? ??????? ????? ???????? (High Priority)

### 6. Large Components ??

**???????**: ?????? ????? ???? ????? ??? ?????

**???????**:
- `app/gmb-dashboard/page.tsx` (860 lines)
- `components/dashboard/gmb-posts-section.tsx` (1002 lines)
- `app/api/gmb/sync/route.ts` (1241 lines)

**????**: ????? ???:
- Smaller components
- Custom hooks
- Utility functions

---

### 7. Performance: N+1 Queries ??

**???????**: Queries ?????? ?? loops

**??????**: `app/api/gmb/sync/route.ts` (lines 952-1067)

**????**:
```typescript
// ????? ??:
for (const location of dbLocations) {
  const { reviews } = await fetchReviews(...)
}

// ??????:
const allReviews = await Promise.all(
  dbLocations.map(loc => fetchReviews(...))
)
```

---

### 8. Missing Rate Limiting ??

**???????**: ?? ???? rate limiting ??? APIs

**????**: ????? middleware:
```typescript
import rateLimit from 'express-rate-limit'

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100 // limit each IP to 100 requests per windowMs
})
```

---

## ? ??????? ????? (Quick Wins)

### ???? ???? ??????:

1. **????? console.log statements**:
   ```typescript
   // ??????? console.log ?? logger
   import { logger } from '@/lib/logger'
   ```

2. **????? Language ?? UI**:
   - Mix ??? Arabic ? English
   - ?????? ??? ????? ?? ????? i18n

3. **??????? confirm() ?? Dialog**:
   ```typescript
   // ????? ??:
   if (!confirm('...')) return
   
   // ??????:
   <Dialog>
     <DialogContent>
       ...
     </DialogContent>
   </Dialog>
   ```

4. **????? Loading Indicators**:
   - ???? async operations ??? ?? ???? loading state

---

## ?? Checklist ????????? ???????

### ?????:
- [ ] ?????? duplicate locations issue
- [ ] ????? Zod validation ??? posts API
- [ ] ????? error response format

### ??? ???????:
- [ ] ????? large components
- [ ] ????? token refresh logic
- [ ] ????? rate limiting
- [ ] ????? error messages security

### ??? ?????:
- [ ] Performance optimization
- [ ] ????? comprehensive tests
- [ ] Documentation improvements

---

*??? ?????: 2025-01-31*
